<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Fuminori Sakamoto">
    <meta name="description" content="horizoon&#39;s website">
    <meta name="keywords" content="blog,developer,backpacker,personal">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Goで構造体へのインタフェース埋め込み活用例（aws-sdk-goの事例など）"/>
<meta name="twitter:description" content="Summary 構造体へのインタフェース埋め込み活用例 ×2
 一部メソッドを別処理に差し替え 特定のメソッドだけを実装  外部APIアクセスなどを伴う機能のテストをmockで行いたい場合に、gomockのようなmock用ライブラリに依存せずにmock化を実現    1 2 3 4 5 6 7 8  type Intf interface { MethodY() MethodZ() } type B struct { Intf // こういう埋め込み }   例1：一部メソッドを別処理に差し替え 無名インタフェースの埋め込み例として本家コードで参考になるのがsort/sort.go のこの実装 です。reverse構造体のコメントにも書いてある通りこうした無名インタフェースを埋め込んだ構造体を利用する事で「一部のメソッドだけ別の実装に差し替える」という事を実現しています。
単純なサンプルコードはこんな感じで、Intfというinterfaceを実装済のAという構造体を ReplaceMethodZ に渡すと、MethodZの挙動だけが異なる別の構造体を取得するという挙動になります。
（同じコードはこちら → https://play.golang.org/p/mh803JB5RSt ）
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  package main import ( &#34;fmt&#34; ) type Intf interface { MethodY() MethodZ() } type A struct { Str string } func (a *A) MethodY() { fmt."/>

    <meta property="og:title" content="Goで構造体へのインタフェース埋め込み活用例（aws-sdk-goの事例など）" />
<meta property="og:description" content="Summary 構造体へのインタフェース埋め込み活用例 ×2
 一部メソッドを別処理に差し替え 特定のメソッドだけを実装  外部APIアクセスなどを伴う機能のテストをmockで行いたい場合に、gomockのようなmock用ライブラリに依存せずにmock化を実現    1 2 3 4 5 6 7 8  type Intf interface { MethodY() MethodZ() } type B struct { Intf // こういう埋め込み }   例1：一部メソッドを別処理に差し替え 無名インタフェースの埋め込み例として本家コードで参考になるのがsort/sort.go のこの実装 です。reverse構造体のコメントにも書いてある通りこうした無名インタフェースを埋め込んだ構造体を利用する事で「一部のメソッドだけ別の実装に差し替える」という事を実現しています。
単純なサンプルコードはこんな感じで、Intfというinterfaceを実装済のAという構造体を ReplaceMethodZ に渡すと、MethodZの挙動だけが異なる別の構造体を取得するという挙動になります。
（同じコードはこちら → https://play.golang.org/p/mh803JB5RSt ）
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  package main import ( &#34;fmt&#34; ) type Intf interface { MethodY() MethodZ() } type A struct { Str string } func (a *A) MethodY() { fmt." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://horizoon.jp/post/2019/03/16/go_embedded_interface/" />
<meta property="article:published_time" content="2019-03-16T12:03:00+09:00" />
<meta property="article:modified_time" content="2019-03-16T12:03:00+09:00" />


    
      <base href="https://horizoon.jp/post/2019/03/16/go_embedded_interface/">
    
    <title>
  Goで構造体へのインタフェース埋め込み活用例（aws-sdk-goの事例など） · horizoon
</title>

    
      <link rel="canonical" href="https://horizoon.jp/post/2019/03/16/go_embedded_interface/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://horizoon.jp/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css" integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="https://horizoon.jp/css/coder-dark.min.83a2010dac9f59f943b3004cd6c4f230507ad036da635d3621401d42ec4e2835.css" integrity="sha256-g6IBDayfWflDswBM1sTyMFB60DbaY102IUAdQuxOKDU=" crossorigin="anonymous" media="screen" />
      
    

    

    

    

    <link rel="icon" type="image/png" href="https://horizoon.jp/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://horizoon.jp/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.67.1" />
  </head>

  
  
    
  
  <body class="colorscheme-auto">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://horizoon.jp/">
      horizoon
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://horizoon.jp/post/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://horizoon.jp/projects/">Projects</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://horizoon.jp/about/">About</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>Goで構造体へのインタフェース埋め込み活用例（aws-sdk-goの事例など）</h1>
    </header>

    <h1 id="summary">Summary</h1>
<p>構造体へのインタフェース埋め込み活用例 ×2</p>
<ol>
<li>一部メソッドを別処理に差し替え</li>
<li>特定のメソッドだけを実装
<ul>
<li>外部APIアクセスなどを伴う機能のテストをmockで行いたい場合に、gomockのようなmock用ライブラリに依存せずにmock化を実現</li>
</ul>
</li>
</ol>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">type</span> Intf <span style="color:#007020;font-weight:bold">interface</span> {
  <span style="color:#06287e">MethodY</span>()
  <span style="color:#06287e">MethodZ</span>()
}

<span style="color:#007020;font-weight:bold">type</span> B <span style="color:#007020;font-weight:bold">struct</span> {
  Intf  <span style="color:#60a0b0;font-style:italic">// こういう埋め込み
</span><span style="color:#60a0b0;font-style:italic"></span>}
</code></pre></td></tr></table>
</div>
</div><h1 id="例1一部メソッドを別処理に差し替え">例1：一部メソッドを別処理に差し替え</h1>
<p>無名インタフェースの埋め込み例として本家コードで参考になるのが<a href="https://github.com/golang/go/blob/master/src/sort/sort.go#L242">sort/sort.go のこの実装</a> です。<code>reverse</code>構造体のコメントにも書いてある通りこうした無名インタフェースを埋め込んだ構造体を利用する事で「一部のメソッドだけ別の実装に差し替える」という事を実現しています。</p>
<p>単純なサンプルコードはこんな感じで、Intfというinterfaceを実装済のAという構造体を <code>ReplaceMethodZ</code> に渡すと、MethodZの挙動だけが異なる別の構造体を取得するという挙動になります。</p>
<p>（同じコードはこちら → <a href="https://play.golang.org/p/mh803JB5RSt">https://play.golang.org/p/mh803JB5RSt</a> ）</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">package</span> main

<span style="color:#007020;font-weight:bold">import</span> (
  <span style="color:#4070a0">&#34;fmt&#34;</span>
)

<span style="color:#007020;font-weight:bold">type</span> Intf <span style="color:#007020;font-weight:bold">interface</span> {
  <span style="color:#06287e">MethodY</span>()
  <span style="color:#06287e">MethodZ</span>()
}

<span style="color:#007020;font-weight:bold">type</span> A <span style="color:#007020;font-weight:bold">struct</span> {
  Str <span style="color:#902000">string</span>
}

<span style="color:#007020;font-weight:bold">func</span> (a <span style="color:#666">*</span>A) <span style="color:#06287e">MethodY</span>() {
  fmt.<span style="color:#06287e">Println</span>(fmt.<span style="color:#06287e">Sprintf</span>(<span style="color:#4070a0">&#34;%s: MethodY&#34;</span>, a.Str))
}

<span style="color:#007020;font-weight:bold">func</span> (a <span style="color:#666">*</span>A) <span style="color:#06287e">MethodZ</span>() {
  fmt.<span style="color:#06287e">Println</span>(fmt.<span style="color:#06287e">Sprintf</span>(<span style="color:#4070a0">&#34;%s: MethodZ&#34;</span>, a.Str))
}

<span style="color:#007020;font-weight:bold">type</span> B <span style="color:#007020;font-weight:bold">struct</span> {
  Intf
}

<span style="color:#007020;font-weight:bold">func</span> (b <span style="color:#666">*</span>B) <span style="color:#06287e">MethodZ</span>() {
  fmt.<span style="color:#06287e">Println</span>(<span style="color:#4070a0">&#34;Replaced MethodZ&#34;</span>)
}

<span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">ReplaceMethodZ</span>(org Intf) Intf {
  <span style="color:#007020;font-weight:bold">return</span> <span style="color:#666">&amp;</span>B{org}
}

<span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">main</span>() {
  a <span style="color:#666">:=</span> <span style="color:#666">&amp;</span>A{Str: <span style="color:#4070a0">&#34;I am A&#34;</span>}
  a.<span style="color:#06287e">MethodY</span>() <span style="color:#60a0b0;font-style:italic">// print &#34;I am A: MethodY&#34;
</span><span style="color:#60a0b0;font-style:italic"></span>  a.<span style="color:#06287e">MethodZ</span>() <span style="color:#60a0b0;font-style:italic">// print &#34;I am A: MethodZ&#34;
</span><span style="color:#60a0b0;font-style:italic"></span>
  r <span style="color:#666">:=</span> <span style="color:#06287e">ReplaceMethodZ</span>(a)
  r.<span style="color:#06287e">MethodY</span>() <span style="color:#60a0b0;font-style:italic">// print &#34;I am A: MethodY&#34;
</span><span style="color:#60a0b0;font-style:italic"></span>  r.<span style="color:#06287e">MethodZ</span>() <span style="color:#60a0b0;font-style:italic">// print &#34;Replaced MethodZ&#34; &lt;= replaced
</span><span style="color:#60a0b0;font-style:italic"></span>}
</code></pre></td></tr></table>
</div>
</div><h1 id="例2特定のメソッドだけを実装">例2：特定のメソッドだけを実装</h1>
<p>sort.goの例は「インタフェースの全メソッドを実装済である構造体をあるメソッドに渡し、渡されたメソッド内で一部メソッドの実装を差し替える（上書きする）」という例でしたが、 下記のような「そもそもインタフェースのメソッドが部分的にしか実装されていない」ようなコードも書くことが出来ます。</p>
<p>（同じコードはこちら → <a href="https://play.golang.org/p/8YvXVtw91Mc">https://play.golang.org/p/8YvXVtw91Mc</a> ）</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#007020;font-weight:bold">package</span> main

<span style="color:#007020;font-weight:bold">import</span> <span style="color:#4070a0">&#34;fmt&#34;</span>

<span style="color:#007020;font-weight:bold">type</span> Intf <span style="color:#007020;font-weight:bold">interface</span> {
  <span style="color:#06287e">GetStrVal</span>() <span style="color:#902000">string</span>
  <span style="color:#06287e">GetIntVal</span>() <span style="color:#902000">int</span>
}

<span style="color:#60a0b0;font-style:italic">// Intfを実装するHoge1構造体
</span><span style="color:#60a0b0;font-style:italic">// 2メソッド漏れなく実装する
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">type</span> Hoge1 <span style="color:#007020;font-weight:bold">struct</span> {
  StrVal <span style="color:#902000">string</span>
  IntVal <span style="color:#902000">int</span>
}

<span style="color:#007020;font-weight:bold">func</span> (h <span style="color:#666">*</span>Hoge1) <span style="color:#06287e">GetStrVal</span>() <span style="color:#902000">string</span> {
  <span style="color:#007020;font-weight:bold">return</span> h.StrVal
}

<span style="color:#007020;font-weight:bold">func</span> (h <span style="color:#666">*</span>Hoge1) <span style="color:#06287e">GetIntVal</span>() <span style="color:#902000">int</span> {
  <span style="color:#007020;font-weight:bold">return</span> h.IntVal
}

<span style="color:#60a0b0;font-style:italic">// 無名インタフェース Intf を埋め込んだHoge2構造体
</span><span style="color:#60a0b0;font-style:italic">// GetIntVal メソッドのみを実装する
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">type</span> Hoge2 <span style="color:#007020;font-weight:bold">struct</span> {
  Intf
}

<span style="color:#007020;font-weight:bold">func</span> (h <span style="color:#666">*</span>Hoge2) <span style="color:#06287e">GetIntVal</span>() <span style="color:#902000">int</span> {
  <span style="color:#007020;font-weight:bold">return</span> <span style="color:#40a070">100</span>
}

<span style="color:#60a0b0;font-style:italic">// interfaceの実装済チェック
</span><span style="color:#60a0b0;font-style:italic">// Hoge2はGetStrValメソッドを実装していないがコンパイルエラーにならない
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">var</span> _ Intf = (<span style="color:#666">*</span>Hoge1)(<span style="color:#007020;font-weight:bold">nil</span>)
<span style="color:#007020;font-weight:bold">var</span> _ Intf = (<span style="color:#666">*</span>Hoge2)(<span style="color:#007020;font-weight:bold">nil</span>)

<span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">main</span>() {
  <span style="color:#06287e">doIntfMethod</span>(<span style="color:#007020">new</span>(Hoge1))
  <span style="color:#06287e">doIntfMethod</span>(<span style="color:#007020">new</span>(Hoge2))
}

<span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">doIntfMethod</span>(intf Intf) {
  fmt.<span style="color:#06287e">Println</span>(intf.<span style="color:#06287e">GetIntVal</span>())

  <span style="color:#60a0b0;font-style:italic">// GetStrValメソッドはHoge2では実装されていないので、呼び出そうとするとpanicが発生する
</span><span style="color:#60a0b0;font-style:italic"></span>  <span style="color:#60a0b0;font-style:italic">// fmt.Println(intf.GetStrVal())
</span><span style="color:#60a0b0;font-style:italic"></span>}
</code></pre></td></tr></table>
</div>
</div><p>活用例として、「テストコードでテスト用の構造体を用意し、インタフェースのメソッド全部ではなくmockしたいメソッドだけを実装したい」というケースを、gomockのような外部ライブラリに頼る事なく実現出来ます。</p>
<h2 id="aws-sdk-go-での例">aws-sdk-go での例</h2>
<p>SQSへのアクセスが発生するアプリケーションのテストを、アクセス部分だけmockして書く例が<a href="https://aws.amazon.com/jp/blogs/developer/mocking-out-then-aws-sdk-for-go-for-unit-testing/">AWS Developer Blogで紹介されています</a>。詳細はリンク先を読んでいただくとして、リンク先のSQSでの例以外にも、例えばEC2でも<a href="https://docs.aws.amazon.com/sdk-for-go/api/service/ec2/ec2iface/">ec2iface というパッケージ</a>が用意されています。このパッケージの<code>EC2API</code>というインタフェースが公式の、</p>
<blockquote>
<p>Package ec2iface provides an interface to enable mocking the Amazon Elastic Compute Cloud service client for testing your code.</p>
</blockquote>
<p>という紹介コメントの通り、テスト時のmock化をサポートしてくれるインタフェースになります。</p>
<p>実際には下記のような書き方で「アクセスが発生する部分だけ、テスト時にmockする」事が出来ます。EC2のインスタンス一覧を取得する場合なら <a href="https://docs.aws.amazon.com/sdk-for-go/api/service/ec2/#EC2.DescribeInstances">DescribeInstances メソッド</a> をmockすると良いです。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#60a0b0;font-style:italic">// 本体のコード
</span><span style="color:#60a0b0;font-style:italic"></span>
<span style="color:#60a0b0;font-style:italic">// ec2ifaceのインタフェースを無名で埋め込んだクライアント用構造体
</span><span style="color:#60a0b0;font-style:italic">// DescribeInstances メソッド もこのインタフェースのメンバーとして定義されている
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">type</span> Client <span style="color:#007020;font-weight:bold">struct</span> {
  ec2iface.EC2API
}

<span style="color:#60a0b0;font-style:italic">// EC2のインスタンス一覧を取得するメソッドを先程の構造体に用意しておく
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">func</span> (client <span style="color:#666">*</span>Client) <span style="color:#06287e">GetInstances</span>() ([]<span style="color:#666">*</span>ec2.Instance, <span style="color:#902000">error</span>) {
  <span style="color:#60a0b0;font-style:italic">// AWSへのアクセスが発生するのはこの箇所
</span><span style="color:#60a0b0;font-style:italic"></span>  is, err <span style="color:#666">:=</span> client.EC2API.<span style="color:#06287e">DescribeInstances</span>(<span style="color:#666">&amp;</span>ec2.DescribeInstancesInput{})

  <span style="color:#007020;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:bold">nil</span> {
    <span style="color:#007020;font-weight:bold">return</span> <span style="color:#007020;font-weight:bold">nil</span>, fmt.<span style="color:#06287e">Errorf</span>(<span style="color:#4070a0">&#34;error: %v&#34;</span>, err)
  }

  <span style="color:#007020;font-weight:bold">var</span> res []<span style="color:#666">*</span>ec2.Instance
  <span style="color:#007020;font-weight:bold">for</span> _, r <span style="color:#666">:=</span> <span style="color:#007020;font-weight:bold">range</span> is.Reservations {
    res = <span style="color:#007020">append</span>(res, r.Instances<span style="color:#666">...</span>)
  }

  <span style="color:#007020;font-weight:bold">return</span> res, <span style="color:#007020;font-weight:bold">nil</span>
}

<span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">NewClient</span>() <span style="color:#666">*</span>Client {
  client <span style="color:#666">:=</span> <span style="color:#007020">new</span>(Client)
  sess <span style="color:#666">:=</span> session.<span style="color:#06287e">Must</span>(session.<span style="color:#06287e">NewSession</span>(aws.<span style="color:#06287e">NewConfig</span>()))
  client.EC2API = ec2.<span style="color:#06287e">New</span>(sess)  <span style="color:#60a0b0;font-style:italic">// 本体コードでは素のEC2オブジェクトをセット
</span><span style="color:#60a0b0;font-style:italic"></span>
  <span style="color:#007020;font-weight:bold">return</span> client
}
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#60a0b0;font-style:italic">// テストコード
</span><span style="color:#60a0b0;font-style:italic"></span>
<span style="color:#60a0b0;font-style:italic">// ec2iface.EC2APIインタフェースを無名で埋め込んだ、mockを行う為の構造体
</span><span style="color:#60a0b0;font-style:italic">// この構造体に独自のDescribeInstancesメソッドを用意してmockする
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">type</span> mock <span style="color:#007020;font-weight:bold">struct</span> {
  ec2iface.EC2API
}

<span style="color:#60a0b0;font-style:italic">// DescribeInstances メソッドだけを、仮の内容でmock
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">func</span> (m <span style="color:#666">*</span>mock) <span style="color:#06287e">DescribeInstances</span>(input <span style="color:#666">*</span>ec2.DescribeInstancesInput) (<span style="color:#666">*</span>ec2.DescribeInstancesOutput, <span style="color:#902000">error</span>) {
  out <span style="color:#666">:=</span> <span style="color:#666">&amp;</span>ec2.DescribeInstancesOutput{
    Reservations: []<span style="color:#666">*</span>ec2.Reservation{
      <span style="color:#666">&amp;</span>ec2.Reservation{Instances: []<span style="color:#666">*</span>ec2.Instance{dummy}},
    },
  }

  <span style="color:#007020;font-weight:bold">return</span> out, <span style="color:#007020;font-weight:bold">nil</span>
}

<span style="color:#007020;font-weight:bold">var</span> dummy = <span style="color:#666">&amp;</span>ec2.Instance{
  InstanceId:       aws.<span style="color:#06287e">String</span>(<span style="color:#4070a0">&#34;i-xxxxxxxxxx&#34;</span>),
  PrivateIpAddress: aws.<span style="color:#06287e">String</span>(<span style="color:#4070a0">&#34;172.31.1.1&#34;</span>),
  InstanceType:     aws.<span style="color:#06287e">String</span>(<span style="color:#4070a0">&#34;t2.nano&#34;</span>),
  State: <span style="color:#666">&amp;</span>ec2.InstanceState{
    Name: aws.<span style="color:#06287e">String</span>(<span style="color:#4070a0">&#34;running&#34;</span>),
  },
}

<span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">TestGetInstances</span>(t <span style="color:#666">*</span>testing.T) {
  client <span style="color:#666">:=</span> <span style="color:#666">&amp;</span>Client{EC2API: <span style="color:#666">&amp;</span>mock{}}  <span style="color:#60a0b0;font-style:italic">// テスト用にmockオブジェクトをセット
</span><span style="color:#60a0b0;font-style:italic"></span>  insts, err <span style="color:#666">:=</span> client.<span style="color:#06287e">GetInstances</span>()  <span style="color:#60a0b0;font-style:italic">// mockしたDescribeInstancesメソッドで返しているインスタンス情報が取得される
</span><span style="color:#60a0b0;font-style:italic"></span>
  <span style="color:#007020;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#007020;font-weight:bold">nil</span> {
    t.<span style="color:#06287e">Errorf</span>(<span style="color:#4070a0">&#34;error occured. err: %#v&#34;</span>, err)
  }

  <span style="color:#007020;font-weight:bold">if</span> insts[<span style="color:#40a070">0</span>].InstanceId <span style="color:#666">!=</span> dummy.InstanceId {
    t.<span style="color:#06287e">Errorf</span>(<span style="color:#4070a0">&#34;expected: %#v, but actual: %#v&#34;</span>, dummy.InstanceId, insts[<span style="color:#40a070">0</span>].InstanceId)
  }
}
</code></pre></td></tr></table>
</div>
</div><h1 id="ブックマーク">ブックマーク</h1>
<ul>
<li><a href="https://stackoverflow.com/questions/24537443/meaning-of-a-struct-with-embedded-anonymous-interface">go - Meaning of a struct with embedded anonymous interface? - Stack Overflow</a></li>
<li><a href="https://aws.amazon.com/jp/blogs/developer/mocking-out-then-aws-sdk-for-go-for-unit-testing/">Mocking Out the AWS SDK for Go for Unit Testing | AWS Developer Blog</a></li>
<li><a href="https://qiita.com/tenntenn/items/bba69d84a1e0b67c4db8">インタフェースを埋込む #golang - Qiita</a></li>
<li><a href="https://qiita.com/tenntenn/items/eac962a49c56b2b15ee8#%E5%9F%8B%E3%82%81%E8%BE%BC%E3%81%BF%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%81%AE%E5%8B%95%E7%9A%84%E5%AE%9F%E8%A3%85">埋め込みを使ったインタフェースの動的実装</a></li>
</ul>

  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    
    
      
        © 2017 - 2020
      
       Fuminori Sakamoto 
    
    
       · 
      Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    
    
  </section>
</footer>

    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-129776715-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


    

  </body>

</html>

<!DOCTYPE html>
<html lang="">
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="This is my portfolio. I&#39;m Web Developer, Software Engineer, Engineering Manager and Backpacker. Ruby/Rails/Go/PHP/Java/Linux/MySQL/Docker/AWS/Fintech/Payment">
<meta name="keywords" content="developer,software engineer,technology,web,blog,freelance,hugo">

<base href="https://horizoon.jp">

<title>
  horizoon - Travis CIによるLambdaの自動デプロイ with AWS SAM in Go 
</title>

<meta name="generator" content="Hugo 0.62.0" />



<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400|Roboto+Slab:400,700|Roboto:300,300i,400,400i,500,500i,700,700i">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
<link rel="stylesheet" href="https://horizoon.jp/css/main.css">
<link rel="stylesheet" href="https://horizoon.jp/css/custom.css">




<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">

</head>
<body lang="">
<div class="container">


<header class="row text-left title">
  <h1 class="title">Travis CIによるLambdaの自動デプロイ with AWS SAM in Go</h1>
</header>
<section id="category-pane" class="row meta">
  
  <div class="col-md-12">
    <h6 class="text-left meta">
        PUBLISHED ON 2019-06-11 
      
      
      
      —
      
      
      <a class="meta" href="/categories/aws">AWS</a>, 
      
      <a class="meta" href="/categories/aws-sam">AWS SAM</a>, 
      
      <a class="meta" href="/categories/go">GO</a>, 
      
      <a class="meta" href="/categories/golang">GOLANG</a>, 
      
      <a class="meta" href="/categories/lambda">LAMBDA</a>, 
      
      <a class="meta" href="/categories/travis-ci">TRAVIS CI</a>
      
      
      
    </h6>
  </div>
  
</section>
<section id="content-pane" class="row">
  <div class="col-md-12 text-justify content">
    
    <h1 id="summary">Summary</h1>
<ul>
<li>AWS SAMで管理しているLambda Functionのデプロイ自動化を、<strong>AWS CodePipelineやAWS CodeBuildを使うことなく</strong> Travis CIを活用して行う
<ul>
<li>今回利用したLambda FunctionはGo製</li>
<li>Pull Requestのmasterブランチへのmerge時に、samコマンドで自動デプロイ</li>
</ul>
</li>
</ul>
<h1 id="heading">前提条件</h1>
<ul>
<li>Lambdaのリポジトリはgithub</li>
<li>各種バージョン情報は下記の通り</li>
</ul>
<pre><code>$ python --version
Python 2.7.12

$ pip --version
pip 19.0.3 from /usr/local/lib/python2.7/dist-packages/pip (python 2.7)

$ aws --version
aws-cli/1.16.175 Python/2.7.12 Linux/4.15.0-1028-gcp botocore/1.12.165

$ sam --version
SAM CLI, version 0.17.0
</code></pre><h1 id="samlambdatravis-ci">SAMで管理しているLambdaのデプロイをTravis CIで自動化したい</h1>
<p>SAMで管理しているLambdaのデプロイ自動化をTravis CIで行います。SAMで管理しているからにはSAMのテンプレートとaws-sam-cliを使ってデプロイを行いたいです。なので<a href="https://docs.travis-ci.com/user/deployment/lambda/">Travis公式のLambdaデプロイサポート</a>は使用しません。</p>
<ul>
<li>branch != master の場合のCI
<ol>
<li>Lambdaコードのテスト</li>
<li>Lambdaコードのlint（golintやgo vetなど）</li>
<li><code>sam validate</code></li>
</ol>
</li>
<li>branch == master の場合のCI, デプロイ
<ol>
<li>CI時に実施した事全て</li>
<li><code>sam package</code></li>
<li><code>sam deploy</code></li>
</ol>
</li>
</ul>
<p>これらを.travis.ymlで定義してデプロイを自動化します。</p>
<h2 id="heading-1">セキュアな環境変数の設定</h2>
<p>Travis CIでsamコマンドを実行したい場合に必要な環境変数は下記の3つです。</p>
<ul>
<li>AWS_ACCESS_KEY_ID</li>
<li>AWS_SECRET_ACCESS_KEY</li>
<li>AWS_DEFAULT_REGION</li>
</ul>
<p>セキュアな変数は <a href="https://docs.travis-ci.com/user/environment-variables/#defining-encrypted-variables-in-travisyml"><code>travis encrypt</code> コマンドで暗号化して.travis.yml に設定します</a>。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ travis encrypt <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>YOUR_KEY_ID

Please add the following to your .travis.yml file:

  secure: <span class="s2">&#34;XXX&#34;</span>  <span class="c1"># この内容を.travis.ymlに設定する</span>

$ travis encrypt <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>YOUR_KEY

Please add the following to your .travis.yml file:

  secure: <span class="s2">&#34;XXX&#34;</span>  <span class="c1"># この内容を.travis.ymlに設定する</span>
</code></pre></div><h2 id="travisyml">.travis.yml</h2>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">dist<span class="p">:</span><span class="w"> </span>xenial<span class="w">
</span><span class="w">
</span><span class="w"></span>go<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span><span class="m">1.12</span>.x<span class="w">
</span><span class="w">
</span><span class="w"></span>sudo<span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w"></span>env<span class="p">:</span><span class="w">
</span><span class="w">  </span>matrix<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>GO111MODULE=on<span class="w">
</span><span class="w">  </span>global<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>AWS_DEFAULT_REGION=ap-northeast<span class="m">-1</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>secure<span class="p">:</span><span class="w"> </span>ENCRYPTED_ACCESS_KEY_ID<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>secure<span class="p">:</span><span class="w"> </span>ENCRYPTED_SECRET_ACCESS_KEY<span class="w">
</span><span class="w">
</span><span class="w"></span>install<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>go<span class="w"> </span>mod<span class="w"> </span>download<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>python<span class="w"> </span>--version<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>pip<span class="w"> </span>--version<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span>awscli<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span>aws-sam-cli<span class="w">
</span><span class="w">
</span><span class="w"></span>script<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>go<span class="w"> </span>test<span class="w"> </span>./...<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>sam<span class="w"> </span>validate<span class="w">
</span><span class="w">
</span><span class="w"></span>deploy<span class="p">:</span><span class="w">
</span><span class="w">  </span>provider<span class="p">:</span><span class="w"> </span>script<span class="w">
</span><span class="w">  </span>script<span class="p">:</span><span class="w"> </span><span class="s2">&#34;./deploy.sh&#34;</span><span class="w">
</span><span class="w">  </span>skip_cleanup<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>on<span class="p">:</span><span class="w">
</span><span class="w">    </span>branch<span class="p">:</span><span class="w"> </span>master<span class="w">
</span><span class="w">
</span><span class="w"></span>notifications<span class="p">:</span><span class="w">
</span><span class="w">  </span>email<span class="p">:</span><span class="w">
</span><span class="w">    </span>on_success<span class="p">:</span><span class="w"> </span>never<span class="w">
</span></code></pre></div><p>pythonのバージョンが古いと<code>sam</code>コマンドがコケるので<a href="https://docs.travis-ci.com/user/reference/xenial/#python-support"><code>dist: xenial</code>でXenialベースのイメージを指定し、極力新しいバージョンのpythonを利用</a>できるようにします。</p>
<p><code>language: go</code>なビルドイメージにインストールされているpythonのバージョンは、<code>dist: xenial</code>を指定しない＝<code>dist: trusty</code>が選択されれば（この記事の執筆時点では）2.7.6になります。例えば<code>sam validate</code>をver 2.7.6なpython環境で実行すると、SNIMissingWarningが発生してしまいます。</p>
<pre><code>/home/travis/.local/lib/python2.7/site-packages/urllib3/util/ssl_.py:365: SNIMissingWarning: An HTTPS request has been made, but the SNI (Server Name Indication) extension to TLS is not available on this platform.
This may cause the server to present an incorrect TLS certificate, which can cause validation failures.
You can upgrade to a newer version of Python to solve this. For more information, see https://urllib3.readthedocs.io/en/latest/advanced-usage.html#ssl-warnings
  SNIMissingWarning
</code></pre><p>deployセクションのscriptで<code>go build</code> =&gt; <code>sam package</code> =&gt; <code>sam deploy</code>を実行するスクリプトを用意・指定します。</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="c1"># ./deploy.sh</span>

<span class="nb">set</span> -eu

<span class="c1"># template.yamlのResourcesの関数定義の内容と合わせる</span>
<span class="c1"># 例えば</span>
<span class="c1">#   CodeUri: hoge/</span>
<span class="c1">#   Handler: huga</span>
<span class="c1"># であれば、</span>
<span class="c1">#   CODE_URI=hoge/</span>
<span class="c1">#   HANDLER=huga</span>
<span class="c1"># とする</span>

<span class="nv">CODE_URI</span><span class="o">=</span>hoge/
<span class="nv">HANDLER</span><span class="o">=</span>huga
<span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build -o <span class="si">${</span><span class="nv">CODE_URI</span><span class="si">}</span><span class="si">${</span><span class="nv">HANDLER</span><span class="si">}</span> <span class="si">${</span><span class="nv">CODE_URI</span><span class="si">}</span>main.go

<span class="nv">TEMPLATE</span><span class="o">=</span>./template.yaml
<span class="nv">OUTPUT_TEMPLATE</span><span class="o">=</span>./serverless-output.yaml  <span class="c1"># デプロイ用の中間生成物なのでgitignoreしておくのが良いです</span>
<span class="nv">S3_BUCKET</span><span class="o">=</span>YOUR_BUCKET
<span class="nv">S3_PREFIX</span><span class="o">=</span>YOUR_PREFIX
<span class="nv">STACK</span><span class="o">=</span>YOUR_STACK

sam package --template-file <span class="si">${</span><span class="nv">TEMPLATE</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>  --output-template-file <span class="si">${</span><span class="nv">OUTPUT_TEMPLATE</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>  --s3-bucket <span class="si">${</span><span class="nv">S3_BUCKET</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>  --s3-prefix <span class="si">${</span><span class="nv">S3_PREFIX</span><span class="si">}</span>

sam deploy --template-file <span class="si">${</span><span class="nv">OUTPUT_TEMPLATE</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>  --stack-name <span class="si">${</span><span class="nv">STACK</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>  --capabilities CAPABILITY_IAM
</code></pre></div><p>これで、今後masterブランチへのpushをトリガーに<code>go build</code> =&gt; <code>sam package</code> =&gt; <code>sam deploy</code> によるデプロイが自動で行われるようになります。</p>
<p>今回の例のように<code>sam package</code> =&gt; <code>sam deploy</code> をシンプルに実行するだけのフローであれば（且つCodePipeline導入によるメリットを享受したい強い理由が無ければ）、Travis CIでも十分でした、という所感です。</p>
<h1 id="heading-2">ブックマーク</h1>
<ul>
<li><a href="https://dev.to/codevbus/deploy-aws-lambda-functions-with-aws-sam-cli-and-travis-ci-3m9m">Deploy AWS Lambda functions with aws-sam-cli and Travis-CI - DEV Community 👩‍💻👨‍💻</a></li>
<li><a href="https://dev.to/codevbus/deploy-aws-lambda-functions-with-aws-sam-cli-and-travis-ci-part-2-2goh">Deploy AWS Lambda functions with aws-sam-cli and Travis-CI: Part 2 - DEV Community 👩‍💻👨‍💻</a></li>
<li><a href="https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/build-pipeline.html">AWS CodePipeline を使用して Lambda アプリケーションの継続的な配信パイプラインを構築する - AWS Lambda</a></li>
<li><a href="https://github.com/aws-samples/cookiecutter-aws-sam-pipeline">aws-samples/cookiecutter-aws-sam-pipeline: Cookiecutter is an Open Source BSD-3 licensed that provides a template engine to scaffold projects. This project is a a cookiecutter template to create a generic CI/CD pipeline for Serverless App based on Serverless Application Model (SAM).</a></li>
<li><a href="https://github.com/Giftbit/sam-scaffold">Giftbit/sam-scaffold: A template for an AWS SAM project with continuous integration.</a>
<ul>
<li>AWS SAMで管理しているLambdaプロジェクト向けのCI雛形集</li>
</ul>
</li>
</ul>

  </div>
</section>
<section id="tag-pane" class="row meta">
  
  <div class="col-md-12">
    <h6 class="text-right meta">
      
      
      
      
    </h6>
  </div>
  
</section>








<section id="menu-pane" class="row menu text-center">
  
  
  <span><a class="menu-item" href="https://horizoon.jp/post/2019/04/18/contributing_with_gomodules/">&lt; prev | </a></span>
  
  
  <span><a class="menu-item" href="/post">post</a></span>
  
  
  <span><a class="menu-item" href="https://horizoon.jp/post/2019/08/16/aws_sdk_go_assumerole/"> | next &gt;</a></span>
  
  
  <h4 class="text-center"><a class="menu-item" href="https://horizoon.jp">home</a></h4>
</section>



<footer class="row text-center footer">
  <hr />
  
  <h6 class="text-center copyright">© 2019. horizoon. <a href="http://creativecommons.org/licenses/by/3.0/">Some Rights Reserved</a>.</h6>
  
  <h6 class="text-center powered">Powered by <a href="https://gohugo.io/">Hugo  v0.62.0</a> &amp; <a href="https://github.com/shenoybr/hugo-goa">Goa</a>.</h6>
  
      
      <h6><a href="" aria-label="RSS Feed"><i class="fas fa-rss" aria-hidden="true"></i></a></h6>
    
  
</footer>

</div>






<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-129776715-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="js/main.js"></script>
<script src="js/custom.js"></script>
</body>
</html>



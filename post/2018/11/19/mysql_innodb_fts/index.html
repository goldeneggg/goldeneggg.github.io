<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Fuminori Sakamoto">
    <meta name="description" content="※ この記事は以前Mediumで公開した記事 の転載です
MySQL5.7・InnoDB・N-gram という環境下で全文検索の挙動やパフォーマンスについて検証を行った。FULLTEXT INDEXは以前はMyISAMでしか利用できなかったが、 5.6.4からInnoDBでのサポートが始まっていた。
InnoDBの全文検索は5.7、特に5.7.6以降でいわゆるCJK（中国語・日本語・韓国語）がN-gramで標準サポートされ始め、 CREATE TABLE文で簡単にパーサーを指定できる構文のサポート、 設定やクエリの組立で考えないといけない事が減った事で導入障壁がかなり下がっている。 ※4.1と5.0でサービス導入経験がある私の個人的な比較感想です。
FULLTEXT INDEXも他のINDEXと同様にデータ更新・削除の際にINDEXのrebuildが走るので更新時の負荷には注意が必要で、FULLTEXT INDEXの場合は「rebuild負荷が列に含まれる単語数に比例する」「rebuildでの断片化が起こりやすい」という固有の注意点もあり、「件数が多い」「FULLTEXT INDEXを貼ったカラムの更新頻度が激しい」という条件が揃ったテーブルへの導入は十分な検証の上で実施した方が良さそう。
下記に書いた検証を経て開発したサービスでも導入してみたが、結論だけ書くと「（当たり前だが）用法用量さえ守れば十分使える。バックエンドのDBがMySQLなら、リッチな全文検索機構を導入する前段階なんかは活用場面としてオススメできる」と感じた。
やること 国税庁が公開している法人番号データを使って検証してみる。データ件数が100万件強程度になるように東京・大阪・海外 の3種類をマージしたデータを使った。用意したデータとテーブルについてはgithubにupしている。charsetをutf8mb4にしているのは、utf8だと登録時にエラーになる文字を含んだ法人が複数存在する為。collationはデフォルトであるuft8mb4_general_ciを使用する。
1 2 3 4 5 6 7 8  &gt; show collation like &#39;utf8mb4%&#39; \G; *************************** 1. row *************************** Collation: utf8mb4_general_ci Charset: utf8mb4 Id: 45 Default: Yes Compiled: Yes Sortlen: 1   今回付けたFULLTEXT INDEXは会社名検索・住所検索を想定したものにしている。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  -- 法人番号データ投入用テーブルのCREATE文 CREATE TABLE `corporate_nums` ( `id` int NOT NULL AUTO_INCREMENT, `sequence_number` varchar(8) NOT NULL, `corporate_number` char(13) DEFAULT NULL, `process` char(2) DEFAULT NULL, `correct` char(1) DEFAULT NULL, `update_date` char(10) DEFAULT NULL, `change_date` char(10) DEFAULT NULL, `name` varchar(150) DEFAULT NULL, `name_image_id` char(8) DEFAULT NULL, `kind` char(3) DEFAULT NULL, `prefecture_name` varchar(10) DEFAULT NULL, `city_name` varchar(20) DEFAULT NULL, `street_number` varchar(300) DEFAULT NULL, `address_image_id` char(8) DEFAULT NULL, `prefecture_code` char(2) DEFAULT NULL, `city_code` char(3) DEFAULT NULL, `post_code` char(7) DEFAULT NULL, `address_outside` varchar(300) DEFAULT NULL, `address_outside_image_id` char(8) DEFAULT NULL, `close_date` char(10) DEFAULT NULL, `close_cause` char(2) DEFAULT NULL, `successor_corporate_number` char(13) DEFAULT NULL, `change_cause` varchar(500) DEFAULT NULL, `assignment_date` char(10), `latest` char(1) DEFAULT NULL, `en_name` varchar(300) DEFAULT NULL, `en_prefecture_name` varchar(9) DEFAULT NULL, `en_city_name` varchar(600) DEFAULT NULL, `en_address_outside` varchar(600) DEFAULT NULL, PRIMARY KEY (`id`), KEY `cn_i1` (`sequence_number`), KEY `cn_i2` (`corporate_number`), FULLTEXT KEY `cn_fti1` (`name`, `en_name`) WITH PARSER ngram, FULLTEXT KEY `cn_fti2` (`prefecture_name`, `city_name`, `street_number`, `en_prefecture_name`, `en_city_name`) WITH PARSER ngram ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC   件数は↓この通り">
    <meta name="keywords" content="blog,developer,backpacker,personal">

    

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MySQL5.7 InnoDB のN-gram全文検索を検証＆サービス導入した"/>
<meta name="twitter:description" content="※ この記事は以前Mediumで公開した記事 の転載です
MySQL5.7・InnoDB・N-gram という環境下で全文検索の挙動やパフォーマンスについて検証を行った。FULLTEXT INDEXは以前はMyISAMでしか利用できなかったが、 5.6.4からInnoDBでのサポートが始まっていた。
InnoDBの全文検索は5.7、特に5.7.6以降でいわゆるCJK（中国語・日本語・韓国語）がN-gramで標準サポートされ始め、 CREATE TABLE文で簡単にパーサーを指定できる構文のサポート、 設定やクエリの組立で考えないといけない事が減った事で導入障壁がかなり下がっている。 ※4.1と5.0でサービス導入経験がある私の個人的な比較感想です。
FULLTEXT INDEXも他のINDEXと同様にデータ更新・削除の際にINDEXのrebuildが走るので更新時の負荷には注意が必要で、FULLTEXT INDEXの場合は「rebuild負荷が列に含まれる単語数に比例する」「rebuildでの断片化が起こりやすい」という固有の注意点もあり、「件数が多い」「FULLTEXT INDEXを貼ったカラムの更新頻度が激しい」という条件が揃ったテーブルへの導入は十分な検証の上で実施した方が良さそう。
下記に書いた検証を経て開発したサービスでも導入してみたが、結論だけ書くと「（当たり前だが）用法用量さえ守れば十分使える。バックエンドのDBがMySQLなら、リッチな全文検索機構を導入する前段階なんかは活用場面としてオススメできる」と感じた。
やること 国税庁が公開している法人番号データを使って検証してみる。データ件数が100万件強程度になるように東京・大阪・海外 の3種類をマージしたデータを使った。用意したデータとテーブルについてはgithubにupしている。charsetをutf8mb4にしているのは、utf8だと登録時にエラーになる文字を含んだ法人が複数存在する為。collationはデフォルトであるuft8mb4_general_ciを使用する。
1 2 3 4 5 6 7 8  &gt; show collation like &#39;utf8mb4%&#39; \G; *************************** 1. row *************************** Collation: utf8mb4_general_ci Charset: utf8mb4 Id: 45 Default: Yes Compiled: Yes Sortlen: 1   今回付けたFULLTEXT INDEXは会社名検索・住所検索を想定したものにしている。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  -- 法人番号データ投入用テーブルのCREATE文 CREATE TABLE `corporate_nums` ( `id` int NOT NULL AUTO_INCREMENT, `sequence_number` varchar(8) NOT NULL, `corporate_number` char(13) DEFAULT NULL, `process` char(2) DEFAULT NULL, `correct` char(1) DEFAULT NULL, `update_date` char(10) DEFAULT NULL, `change_date` char(10) DEFAULT NULL, `name` varchar(150) DEFAULT NULL, `name_image_id` char(8) DEFAULT NULL, `kind` char(3) DEFAULT NULL, `prefecture_name` varchar(10) DEFAULT NULL, `city_name` varchar(20) DEFAULT NULL, `street_number` varchar(300) DEFAULT NULL, `address_image_id` char(8) DEFAULT NULL, `prefecture_code` char(2) DEFAULT NULL, `city_code` char(3) DEFAULT NULL, `post_code` char(7) DEFAULT NULL, `address_outside` varchar(300) DEFAULT NULL, `address_outside_image_id` char(8) DEFAULT NULL, `close_date` char(10) DEFAULT NULL, `close_cause` char(2) DEFAULT NULL, `successor_corporate_number` char(13) DEFAULT NULL, `change_cause` varchar(500) DEFAULT NULL, `assignment_date` char(10), `latest` char(1) DEFAULT NULL, `en_name` varchar(300) DEFAULT NULL, `en_prefecture_name` varchar(9) DEFAULT NULL, `en_city_name` varchar(600) DEFAULT NULL, `en_address_outside` varchar(600) DEFAULT NULL, PRIMARY KEY (`id`), KEY `cn_i1` (`sequence_number`), KEY `cn_i2` (`corporate_number`), FULLTEXT KEY `cn_fti1` (`name`, `en_name`) WITH PARSER ngram, FULLTEXT KEY `cn_fti2` (`prefecture_name`, `city_name`, `street_number`, `en_prefecture_name`, `en_city_name`) WITH PARSER ngram ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC   件数は↓この通り"/>

    <meta property="og:title" content="MySQL5.7 InnoDB のN-gram全文検索を検証＆サービス導入した" />
<meta property="og:description" content="※ この記事は以前Mediumで公開した記事 の転載です
MySQL5.7・InnoDB・N-gram という環境下で全文検索の挙動やパフォーマンスについて検証を行った。FULLTEXT INDEXは以前はMyISAMでしか利用できなかったが、 5.6.4からInnoDBでのサポートが始まっていた。
InnoDBの全文検索は5.7、特に5.7.6以降でいわゆるCJK（中国語・日本語・韓国語）がN-gramで標準サポートされ始め、 CREATE TABLE文で簡単にパーサーを指定できる構文のサポート、 設定やクエリの組立で考えないといけない事が減った事で導入障壁がかなり下がっている。 ※4.1と5.0でサービス導入経験がある私の個人的な比較感想です。
FULLTEXT INDEXも他のINDEXと同様にデータ更新・削除の際にINDEXのrebuildが走るので更新時の負荷には注意が必要で、FULLTEXT INDEXの場合は「rebuild負荷が列に含まれる単語数に比例する」「rebuildでの断片化が起こりやすい」という固有の注意点もあり、「件数が多い」「FULLTEXT INDEXを貼ったカラムの更新頻度が激しい」という条件が揃ったテーブルへの導入は十分な検証の上で実施した方が良さそう。
下記に書いた検証を経て開発したサービスでも導入してみたが、結論だけ書くと「（当たり前だが）用法用量さえ守れば十分使える。バックエンドのDBがMySQLなら、リッチな全文検索機構を導入する前段階なんかは活用場面としてオススメできる」と感じた。
やること 国税庁が公開している法人番号データを使って検証してみる。データ件数が100万件強程度になるように東京・大阪・海外 の3種類をマージしたデータを使った。用意したデータとテーブルについてはgithubにupしている。charsetをutf8mb4にしているのは、utf8だと登録時にエラーになる文字を含んだ法人が複数存在する為。collationはデフォルトであるuft8mb4_general_ciを使用する。
1 2 3 4 5 6 7 8  &gt; show collation like &#39;utf8mb4%&#39; \G; *************************** 1. row *************************** Collation: utf8mb4_general_ci Charset: utf8mb4 Id: 45 Default: Yes Compiled: Yes Sortlen: 1   今回付けたFULLTEXT INDEXは会社名検索・住所検索を想定したものにしている。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  -- 法人番号データ投入用テーブルのCREATE文 CREATE TABLE `corporate_nums` ( `id` int NOT NULL AUTO_INCREMENT, `sequence_number` varchar(8) NOT NULL, `corporate_number` char(13) DEFAULT NULL, `process` char(2) DEFAULT NULL, `correct` char(1) DEFAULT NULL, `update_date` char(10) DEFAULT NULL, `change_date` char(10) DEFAULT NULL, `name` varchar(150) DEFAULT NULL, `name_image_id` char(8) DEFAULT NULL, `kind` char(3) DEFAULT NULL, `prefecture_name` varchar(10) DEFAULT NULL, `city_name` varchar(20) DEFAULT NULL, `street_number` varchar(300) DEFAULT NULL, `address_image_id` char(8) DEFAULT NULL, `prefecture_code` char(2) DEFAULT NULL, `city_code` char(3) DEFAULT NULL, `post_code` char(7) DEFAULT NULL, `address_outside` varchar(300) DEFAULT NULL, `address_outside_image_id` char(8) DEFAULT NULL, `close_date` char(10) DEFAULT NULL, `close_cause` char(2) DEFAULT NULL, `successor_corporate_number` char(13) DEFAULT NULL, `change_cause` varchar(500) DEFAULT NULL, `assignment_date` char(10), `latest` char(1) DEFAULT NULL, `en_name` varchar(300) DEFAULT NULL, `en_prefecture_name` varchar(9) DEFAULT NULL, `en_city_name` varchar(600) DEFAULT NULL, `en_address_outside` varchar(600) DEFAULT NULL, PRIMARY KEY (`id`), KEY `cn_i1` (`sequence_number`), KEY `cn_i2` (`corporate_number`), FULLTEXT KEY `cn_fti1` (`name`, `en_name`) WITH PARSER ngram, FULLTEXT KEY `cn_fti2` (`prefecture_name`, `city_name`, `street_number`, `en_prefecture_name`, `en_city_name`) WITH PARSER ngram ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC   件数は↓この通り" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://horizoon.jp/post/2018/11/19/mysql_innodb_fts/" />
<meta property="article:published_time" content="2018-11-19T03:21:36+09:00" />
<meta property="article:modified_time" content="2018-11-19T03:21:36+09:00" />


    
      <base href="https://horizoon.jp/post/2018/11/19/mysql_innodb_fts/">
    
    <title>
  MySQL5.7 InnoDB のN-gram全文検索を検証＆サービス導入した · horizoon
</title>

    
      <link rel="canonical" href="https://horizoon.jp/post/2018/11/19/mysql_innodb_fts/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css" integrity="sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://horizoon.jp/css/coder.min.3219ef62ae52679b7a9c19043171c3cd9f523628c2a65f3ef247ee18836bc90b.css" integrity="sha256-MhnvYq5SZ5t6nBkEMXHDzZ9SNijCpl8&#43;8kfuGINryQs=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="https://horizoon.jp/css/coder-dark.min.e78e80fc3a585a4d1c8fc7f58623b6ff852411e38431a9cd1792877ecaa160f6.css" integrity="sha256-546A/DpYWk0cj8f1hiO2/4UkEeOEManNF5KHfsqhYPY=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="https://horizoon.jp/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://horizoon.jp/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.74.1" />
  </head>

  
  
    
  
  <body class="colorscheme-auto"
        onload=""
  >
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://horizoon.jp/">
      horizoon
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://horizoon.jp/post/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://horizoon.jp/projects/">Projects</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://horizoon.jp/about/">About</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>MySQL5.7 InnoDB のN-gram全文検索を検証＆サービス導入した</h1>
    </header>

    <p>※ この記事は<a href="https://medium.com/@golden_eggg/mysql5-7-innodb-%E3%81%AEn-gram%E5%85%A8%E6%96%87%E6%A4%9C%E7%B4%A2%E3%82%92%E6%A4%9C%E8%A8%BC-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E5%B0%8E%E5%85%A5%E3%81%97%E3%81%9F-a3d733480605">以前Mediumで公開した記事</a> の転載です</p>
<p>MySQL5.7・InnoDB・N-gram という環境下で全文検索の挙動やパフォーマンスについて検証を行った。FULLTEXT INDEXは以前はMyISAMでしか利用できなかったが、 <a href="http://y-ken.hatenablog.com/entry/mysql-casual-talks-vol4-innodb-fts">5.6.4からInnoDBでのサポートが始まっていた</a>。</p>
<p>InnoDBの全文検索は5.7、特に<a href="https://dev.mysql.com/doc/refman/5.7/en/fulltext-search-ngram.html">5.7.6以降でいわゆるCJK（中国語・日本語・韓国語）がN-gramで標準サポート</a>され始め、 <a href="http://mysqlserverteam.com/innodb-%E5%85%A8%E6%96%87%E6%A4%9C%E7%B4%A2-n-gram-parser/">CREATE TABLE文で簡単にパーサーを指定できる構文のサポート</a>、 設定やクエリの組立で考えないといけない事が減った事で導入障壁がかなり下がっている。 ※4.1と5.0でサービス導入経験がある私の個人的な比較感想です。</p>
<p>FULLTEXT INDEXも他のINDEXと同様にデータ更新・削除の際にINDEXのrebuildが走るので更新時の負荷には注意が必要で、FULLTEXT INDEXの場合は「rebuild負荷が列に含まれる単語数に比例する」「rebuildでの断片化が起こりやすい」という固有の注意点もあり、「件数が多い」「FULLTEXT INDEXを貼ったカラムの更新頻度が激しい」という条件が揃ったテーブルへの導入は十分な検証の上で実施した方が良さそう。</p>
<p>下記に書いた検証を経て開発したサービスでも導入してみたが、結論だけ書くと「（当たり前だが）用法用量さえ守れば十分使える。バックエンドのDBがMySQLなら、リッチな全文検索機構を導入する前段階なんかは活用場面としてオススメできる」と感じた。</p>
<h2 id="やること">やること</h2>
<p><a href="http://www.houjin-bangou.nta.go.jp/download/zenken/#csv-unicode">国税庁が公開している法人番号データ</a>を使って検証してみる。データ件数が100万件強程度になるように東京・大阪・海外 の3種類をマージしたデータを使った。用意したデータとテーブルについては<a href="https://github.com/practice-goldeneggg/mysql-innodb-fts">githubにupしている</a>。charsetをutf8mb4にしているのは、utf8だと登録時にエラーになる文字を含んだ法人が複数存在する為。collationはデフォルトであるuft8mb4_general_ciを使用する。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">show</span> <span style="color:#007020;font-weight:bold">collation</span> <span style="color:#007020;font-weight:bold">like</span> <span style="color:#4070a0">&#39;utf8mb4%&#39;</span> <span style="">\</span><span style="color:#007020;font-weight:bold">G</span>;
<span style="color:#666">***************************</span> <span style="color:#40a070">1</span>. <span style="color:#007020;font-weight:bold">row</span> <span style="color:#666">***************************</span>
<span style="color:#007020;font-weight:bold">Collation</span>: utf8mb4_general_ci
  Charset: utf8mb4
       Id: <span style="color:#40a070">45</span>
  <span style="color:#007020;font-weight:bold">Default</span>: Yes
 Compiled: Yes
  Sortlen: <span style="color:#40a070">1</span>
</code></pre></td></tr></table>
</div>
</div><p>今回付けたFULLTEXT INDEXは会社名検索・住所検索を想定したものにしている。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#60a0b0;font-style:italic">-- 法人番号データ投入用テーブルのCREATE文
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">CREATE</span> <span style="color:#007020;font-weight:bold">TABLE</span> <span style="color:#666">`</span>corporate_nums<span style="color:#666">`</span> (
  <span style="color:#666">`</span>id<span style="color:#666">`</span> <span style="color:#007020">int</span> <span style="color:#007020;font-weight:bold">NOT</span> <span style="color:#007020;font-weight:bold">NULL</span> AUTO_INCREMENT,
  <span style="color:#666">`</span>sequence_number<span style="color:#666">`</span> <span style="color:#007020">varchar</span>(<span style="color:#40a070">8</span>) <span style="color:#007020;font-weight:bold">NOT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>corporate_number<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">13</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>process<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">2</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>correct<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">1</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>update_date<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">10</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>change_date<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">10</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>name<span style="color:#666">`</span> <span style="color:#007020">varchar</span>(<span style="color:#40a070">150</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>name_image_id<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">8</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>kind<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">3</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>prefecture_name<span style="color:#666">`</span> <span style="color:#007020">varchar</span>(<span style="color:#40a070">10</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>city_name<span style="color:#666">`</span> <span style="color:#007020">varchar</span>(<span style="color:#40a070">20</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>street_number<span style="color:#666">`</span> <span style="color:#007020">varchar</span>(<span style="color:#40a070">300</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>address_image_id<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">8</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>prefecture_code<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">2</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>city_code<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">3</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>post_code<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">7</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>address_outside<span style="color:#666">`</span> <span style="color:#007020">varchar</span>(<span style="color:#40a070">300</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>address_outside_image_id<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">8</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>close_date<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">10</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>close_cause<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">2</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>successor_corporate_number<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">13</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>change_cause<span style="color:#666">`</span> <span style="color:#007020">varchar</span>(<span style="color:#40a070">500</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>assignment_date<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">10</span>),
  <span style="color:#666">`</span>latest<span style="color:#666">`</span> <span style="color:#007020">char</span>(<span style="color:#40a070">1</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>en_name<span style="color:#666">`</span> <span style="color:#007020">varchar</span>(<span style="color:#40a070">300</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>en_prefecture_name<span style="color:#666">`</span> <span style="color:#007020">varchar</span>(<span style="color:#40a070">9</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>en_city_name<span style="color:#666">`</span> <span style="color:#007020">varchar</span>(<span style="color:#40a070">600</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#666">`</span>en_address_outside<span style="color:#666">`</span> <span style="color:#007020">varchar</span>(<span style="color:#40a070">600</span>) <span style="color:#007020;font-weight:bold">DEFAULT</span> <span style="color:#007020;font-weight:bold">NULL</span>,
  <span style="color:#007020;font-weight:bold">PRIMARY</span> <span style="color:#007020;font-weight:bold">KEY</span> (<span style="color:#666">`</span>id<span style="color:#666">`</span>),
  <span style="color:#007020;font-weight:bold">KEY</span> <span style="color:#666">`</span>cn_i1<span style="color:#666">`</span> (<span style="color:#666">`</span>sequence_number<span style="color:#666">`</span>),
  <span style="color:#007020;font-weight:bold">KEY</span> <span style="color:#666">`</span>cn_i2<span style="color:#666">`</span> (<span style="color:#666">`</span>corporate_number<span style="color:#666">`</span>),
  FULLTEXT <span style="color:#007020;font-weight:bold">KEY</span> <span style="color:#666">`</span>cn_fti1<span style="color:#666">`</span> (<span style="color:#666">`</span>name<span style="color:#666">`</span>, <span style="color:#666">`</span>en_name<span style="color:#666">`</span>) <span style="color:#007020;font-weight:bold">WITH</span> PARSER ngram,
  FULLTEXT <span style="color:#007020;font-weight:bold">KEY</span> <span style="color:#666">`</span>cn_fti2<span style="color:#666">`</span> (<span style="color:#666">`</span>prefecture_name<span style="color:#666">`</span>, <span style="color:#666">`</span>city_name<span style="color:#666">`</span>, <span style="color:#666">`</span>street_number<span style="color:#666">`</span>, <span style="color:#666">`</span>en_prefecture_name<span style="color:#666">`</span>, <span style="color:#666">`</span>en_city_name<span style="color:#666">`</span>) <span style="color:#007020;font-weight:bold">WITH</span> PARSER ngram
) ENGINE<span style="color:#666">=</span>InnoDB <span style="color:#007020;font-weight:bold">DEFAULT</span> CHARSET<span style="color:#666">=</span>utf8mb4 ROW_FORMAT<span style="color:#666">=</span><span style="color:#007020;font-weight:bold">DYNAMIC</span>
</code></pre></td></tr></table>
</div>
</div><p>件数は↓この通り</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">select</span> <span style="color:#007020;font-weight:bold">count</span>(<span style="color:#666">*</span>) <span style="color:#007020;font-weight:bold">from</span> corporate_nums;
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">count</span>(<span style="color:#666">*</span>) <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span>  <span style="color:#40a070">1369037</span> <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----------+
</span></code></pre></td></tr></table>
</div>
</div><h2 id="検証環境">検証環境</h2>
<p>InnoDBのFULLTEXT INDEXに関連するパラメータは全てデフォルトのままで変更はしない。単語分割の単位は通常 <code>innodb_ft_min_token_size</code> と <code>innodb_ft_max_token_size</code> で設定するのだが、N-gramの場合は無視されて代わりに <code>ngram_token_size</code> というパラメータの内容が適用される。デフォルト値は2なので、今回の検証では 2-gram で分割されたwordで転置インデックスが登録される。例として「富士山」というデータの場合は「富士」「士山」の2通りのwordで登録される。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">show</span> variables <span style="color:#007020;font-weight:bold">like</span> <span style="color:#4070a0">&#39;innodb_ft%&#39;</span>;
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">---------------------------------+----------------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span> Variable_name                   <span style="color:#666">|</span> Value          <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">---------------------------------+----------------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span> innodb_ft_aux_table             <span style="color:#666">|</span>                <span style="color:#666">|</span>
<span style="color:#666">|</span> innodb_ft_cache_size            <span style="color:#666">|</span> <span style="color:#40a070">8000000</span>        <span style="color:#666">|</span>
<span style="color:#666">|</span> innodb_ft_enable_diag_print     <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">OFF</span>            <span style="color:#666">|</span>
<span style="color:#666">|</span> innodb_ft_enable_stopword       <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">ON</span>             <span style="color:#666">|</span>
<span style="color:#666">|</span> innodb_ft_max_token_size        <span style="color:#666">|</span> <span style="color:#40a070">84</span>             <span style="color:#666">|</span>
<span style="color:#666">|</span> innodb_ft_min_token_size        <span style="color:#666">|</span> <span style="color:#40a070">3</span>              <span style="color:#666">|</span>
<span style="color:#666">|</span> innodb_ft_num_word_optimize     <span style="color:#666">|</span> <span style="color:#40a070">2000</span>           <span style="color:#666">|</span>
<span style="color:#666">|</span> innodb_ft_result_cache_limit    <span style="color:#666">|</span> <span style="color:#40a070">2000000000</span>     <span style="color:#666">|</span>
<span style="color:#666">|</span> innodb_ft_server_stopword_table <span style="color:#666">|</span>                <span style="color:#666">|</span>
<span style="color:#666">|</span> innodb_ft_sort_pll_degree       <span style="color:#666">|</span> <span style="color:#40a070">2</span>              <span style="color:#666">|</span>
<span style="color:#666">|</span> innodb_ft_total_cache_size      <span style="color:#666">|</span> <span style="color:#40a070">640000000</span>      <span style="color:#666">|</span>
<span style="color:#666">|</span> innodb_ft_user_stopword_table   <span style="color:#666">|</span>                <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">---------------------------------+----------------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">show</span> variables <span style="color:#007020;font-weight:bold">like</span> <span style="color:#4070a0">&#39;ngram_token_size&#39;</span>;
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">------------------+-------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span> Variable_name    <span style="color:#666">|</span> Value <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">------------------+-------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span> ngram_token_size <span style="color:#666">|</span> <span style="color:#40a070">2</span>     <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">------------------+-------+
</span></code></pre></td></tr></table>
</div>
</div><p>INDEXの状態を確認しながら検証したいので、INFORMATION_SCHEMA INNODB_FT_INDEX_TABLE テーブルが使える準備をしておく。このテーブルはInnoDB FULLTEXT INDEXの転置インデックス管理を行う為のテーブルで、2-gramで分けられたwordとそれらに振られるID・出現頻度 などが登録される。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">SET</span> <span style="color:#007020;font-weight:bold">GLOBAL</span> innodb_optimize_fulltext_only<span style="color:#666">=</span><span style="color:#007020;font-weight:bold">ON</span>;
mysql<span style="color:#666">&gt;</span> OPTIMIZE <span style="color:#007020;font-weight:bold">TABLE</span> corporate_nums;
mysql<span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">SET</span> <span style="color:#007020;font-weight:bold">GLOBAL</span> innodb_ft_aux_table <span style="color:#666">=</span> <span style="color:#4070a0">&#39;dummy/corporate_nums&#39;</span>;   <span style="color:#60a0b0;font-style:italic">-- &#39;DB名/TBL名&#39;
</span><span style="color:#60a0b0;font-style:italic"></span>mysql<span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">SELECT</span> word, doc_count, doc_id, <span style="color:#007020;font-weight:bold">position</span> <span style="color:#007020;font-weight:bold">FROM</span> INFORMATION_SCHEMA.INNODB_FT_INDEX_TABLE <span style="color:#007020;font-weight:bold">LIMIT</span> <span style="color:#40a070">5</span>;
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">------+-----------+---------+----------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span> word <span style="color:#666">|</span> doc_count <span style="color:#666">|</span> doc_id  <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">position</span> <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">------+-----------+---------+----------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span> <span style="color:#4070a0">&#39;s   |         1 |  128141 |       82 |
</span><span style="color:#4070a0">| &#39;</span>s   <span style="color:#666">|</span>         <span style="color:#40a070">1</span> <span style="color:#666">|</span> <span style="color:#40a070">1347655</span> <span style="color:#666">|</span>       <span style="color:#40a070">54</span> <span style="color:#666">|</span>
<span style="color:#666">|</span> (d   <span style="color:#666">|</span>         <span style="color:#40a070">1</span> <span style="color:#666">|</span>  <span style="color:#40a070">775740</span> <span style="color:#666">|</span>      <span style="color:#40a070">106</span> <span style="color:#666">|</span>
<span style="color:#666">|</span> (f   <span style="color:#666">|</span>         <span style="color:#40a070">1</span> <span style="color:#666">|</span> <span style="color:#40a070">1162473</span> <span style="color:#666">|</span>       <span style="color:#40a070">63</span> <span style="color:#666">|</span>
<span style="color:#666">|</span> (j   <span style="color:#666">|</span>         <span style="color:#40a070">1</span> <span style="color:#666">|</span>  <span style="color:#40a070">134835</span> <span style="color:#666">|</span>      <span style="color:#40a070">118</span> <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">------+-----------+---------+----------+
</span></code></pre></td></tr></table>
</div>
</div><h2 id="結果と考察">結果と考察</h2>
<ul>
<li>INDEXが効かない部分一致LIKE</li>
<li>FULLTEXT INDEXを使っての部分一致</li>
</ul>
<p>の2パターンで比較してみる。<a href="https://dev.mysql.com/doc/refman/5.7/en/fulltext-search.html">全文検索モード</a>については、検索対象が固有名詞で自然言語による曖昧検索を行うと検索結果に含まれるノイズが増えそう＝法人番号社名検索という用途には不向き という判断で、<a href="https://dev.mysql.com/doc/refman/5.7/en/fulltext-boolean.html">BOOLEAN MODE</a>で厳密にマッチする検索を行う。</p>
<p>まず name, en_name の2カラムを対象に &ldquo;コード&rdquo; という文字列でLIKE検索(2カラム分のLIKE条件をORで結合）と全文検索の結果を比較してみると、前者が約1.2sec、後者が約0.2secと、全文検索によってパフォーマンスが良くなった。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">EXPLAIN</span> <span style="color:#007020;font-weight:bold">SELECT</span> <span style="color:#007020;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#007020;font-weight:bold">FROM</span> corporate_nums <span style="color:#007020;font-weight:bold">WHERE</span> name <span style="color:#007020;font-weight:bold">LIKE</span> <span style="color:#4070a0">&#39;%コード%&#39;</span> <span style="color:#007020;font-weight:bold">or</span> en_name <span style="color:#007020;font-weight:bold">LIKE</span> <span style="color:#4070a0">&#39;%コード%&#39;</span>;
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----+-------------+----------------+------------+------+---------------+------+---------+------+---------+----------+-------------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span> id <span style="color:#666">|</span> select_type <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">table</span>          <span style="color:#666">|</span> partitions <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">type</span> <span style="color:#666">|</span> possible_keys <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">key</span>  <span style="color:#666">|</span> key_len <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">ref</span>  <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">rows</span>    <span style="color:#666">|</span> filtered <span style="color:#666">|</span> Extra       <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----+-------------+----------------+------------+------+---------------+------+---------+------+---------+----------+-------------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span>  <span style="color:#40a070">1</span> <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">SIMPLE</span>      <span style="color:#666">|</span> corporate_nums <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span>       <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">ALL</span>  <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span>          <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span> <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span>    <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span> <span style="color:#666">|</span> <span style="color:#40a070">1273830</span> <span style="color:#666">|</span>    <span style="color:#40a070">20</span>.<span style="color:#40a070">99</span> <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">Using</span> <span style="color:#007020;font-weight:bold">where</span> <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----+-------------+----------------+------------+------+---------------+------+---------+------+---------+----------+-------------+
</span><span style="color:#60a0b0;font-style:italic"></span>mysql<span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">SELECT</span> SQL_NO_CACHE <span style="color:#007020;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#007020;font-weight:bold">FROM</span> corporate_nums <span style="color:#007020;font-weight:bold">WHERE</span> name <span style="color:#007020;font-weight:bold">LIKE</span> <span style="color:#4070a0">&#39;%コード%&#39;</span> <span style="color:#007020;font-weight:bold">or</span> en_name <span style="color:#007020;font-weight:bold">LIKE</span> <span style="color:#4070a0">&#39;%コード%&#39;</span>;
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span>      <span style="color:#40a070">566</span> <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#40a070">1</span> <span style="color:#007020;font-weight:bold">row</span> <span style="color:#007020;font-weight:bold">in</span> <span style="color:#007020;font-weight:bold">set</span>, <span style="color:#40a070">1</span> warning (<span style="color:#40a070">1</span>.<span style="color:#40a070">26</span> sec)
mysql<span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">EXPLAIN</span> <span style="color:#007020;font-weight:bold">SELECT</span> <span style="color:#007020;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#007020;font-weight:bold">FROM</span> corporate_nums <span style="color:#007020;font-weight:bold">WHERE</span> <span style="color:#007020;font-weight:bold">MATCH</span>(name, en_name) AGAINST(<span style="color:#4070a0">&#39;コード&#39;</span> <span style="color:#007020;font-weight:bold">IN</span> <span style="color:#007020">BOOLEAN</span> <span style="color:#007020;font-weight:bold">MODE</span>);
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+------------------------------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span> id <span style="color:#666">|</span> select_type <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">table</span> <span style="color:#666">|</span> partitions <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">type</span> <span style="color:#666">|</span> possible_keys <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">key</span>  <span style="color:#666">|</span> key_len <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">ref</span>  <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">rows</span> <span style="color:#666">|</span> filtered <span style="color:#666">|</span> Extra                        <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+------------------------------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span>  <span style="color:#40a070">1</span> <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">SIMPLE</span>      <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span>  <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span>       <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span> <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span>          <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span> <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span>    <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span> <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">NULL</span> <span style="color:#666">|</span>     <span style="color:#007020;font-weight:bold">NULL</span> <span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">Select</span> tables optimized away <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+------------------------------+
</span><span style="color:#60a0b0;font-style:italic"></span>mysql<span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:bold">SELECT</span> SQL_NO_CACHE <span style="color:#007020;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#007020;font-weight:bold">FROM</span> corporate_nums <span style="color:#007020;font-weight:bold">WHERE</span> <span style="color:#007020;font-weight:bold">MATCH</span>(name, en_name) AGAINST(<span style="color:#4070a0">&#39;コード&#39;</span> <span style="color:#007020;font-weight:bold">IN</span> <span style="color:#007020">BOOLEAN</span> <span style="color:#007020;font-weight:bold">MODE</span>);
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span> <span style="color:#007020;font-weight:bold">COUNT</span>(<span style="color:#666">*</span>) <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#666">|</span>      <span style="color:#40a070">566</span> <span style="color:#666">|</span>
<span style="color:#666">+</span><span style="color:#60a0b0;font-style:italic">----------+
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#40a070">1</span> <span style="color:#007020;font-weight:bold">row</span> <span style="color:#007020;font-weight:bold">in</span> <span style="color:#007020;font-weight:bold">set</span>, <span style="color:#40a070">1</span> warning (<span style="color:#40a070">0</span>.<span style="color:#40a070">20</span> sec)
</code></pre></td></tr></table>
</div>
</div><p>同じような <code>SELECT COUNT(*)</code> なクエリによる比較調査を検索対象文字列を変えつつ試してみた結果は下記の通りとなった。文字列については「2文字 or NOT」という根拠で選んで、件数と応答速度に関連があるという予想で比較してみた。
※応答速度は10回クエリを投げてみての平均値を採用している。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">| 文字列       | LIKE検索応答速度 | 全文検索応答速度 | HIT件数 |
|:-----------:|---------------:|--------------:|--------:|
| ワーク        | 1.28 sec       | 0.50 sec      | 9,132   |
| コード        | 1.21 sec       | 0.20 sec      | 566     |
| アイス        | 1.27 sec       | 0.09 sec      | 254     |
| 開発        | 1.23 sec       | 0.01 sec      | 6,151   |
| 牧場        | 1.26 sec       | 0.00 sec      | 82      |
| 佐々木       | 1.24 sec       | 0.01 sec      | 569     |
| 五反田       | 1.22 sec       | 0.00 sec      | 61      |
</code></pre></td></tr></table>
</div>
</div><p>文字数が同じでHIT件数も限りなく近い「コード」と「佐々木」が、応答速度では「佐々木」が速い（「コード」が遅い）という結果になった。「コード」に限らず、カタカナでの全文検索は速度が落ちるという結果になった ※これについてはもうちょっと深掘りして調べてみたい。</p>
<h2 id="memo-全文検索結果のソートについて">MEMO: 全文検索結果のソートについて</h2>
<ul>
<li>例えばLIMITによるページングの為に結果をソートするようなケースで、適合性以外でORDER BYすると100% filesortが発生するので避ける。IDのような主キーでORDER BYしても同じ</li>
<li>全文検索結果のソートは 適合性が高い順 がデフォルトの挙動で、<code>MATCH AGAINST</code> をSELECT対象にも含めると適合性が取得でき、この適合性でソートすると速い</li>
<li>↓こういうSQLを書くと速い。<code>ASC</code> だと遅くなってしまう</li>
</ul>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#007020;font-weight:bold">SELECT</span>
  <span style="color:#666">*</span>,
  <span style="color:#007020;font-weight:bold">MATCH</span>(name) AGAINST (<span style="color:#4070a0">&#39;東京&#39;</span> <span style="color:#007020;font-weight:bold">IN</span> <span style="color:#007020">BOOLEAN</span> <span style="color:#007020;font-weight:bold">MODE</span>) <span style="color:#007020;font-weight:bold">AS</span> score
<span style="color:#007020;font-weight:bold">FROM</span>
  corporate_nums
<span style="color:#007020;font-weight:bold">WHERE</span>
  <span style="color:#007020;font-weight:bold">MATCH</span>(name) AGAINST (<span style="color:#4070a0">&#39;東京&#39;</span> <span style="color:#007020;font-weight:bold">IN</span> <span style="color:#007020">BOOLEAN</span> <span style="color:#007020;font-weight:bold">MODE</span>)
<span style="color:#007020;font-weight:bold">ORDER</span> <span style="color:#007020;font-weight:bold">BY</span> score  <span style="color:#007020;font-weight:bold">DESC</span>  <span style="color:#60a0b0;font-style:italic">-- ASCは遅くなる
</span><span style="color:#60a0b0;font-style:italic"></span><span style="color:#007020;font-weight:bold">LIMIT</span> <span style="color:#40a070">0</span>,<span style="color:#40a070">10</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="memo-fulltext-indexの挙動について">MEMO: FULLTEXT INDEXの挙動について</h2>
<ul>
<li>FULLTEXT INDEXのみ付与されたカラムに、MATCH AGAINST文以外の条件指定をした場合、INDEXは効かない</li>
<li>FULLTEXT INDEXのみ付与されたカラム + 他INDEXが付与されたカラム の複合条件を指定した場合、 「他INDEXが付与されたカラム」による絞込の方が効率的であってもそのINDEXは無視されて、FULLTEXT INDEXによる検索が実行される</li>
<li>FULLTEXT INDEXでもカバリングインデックスとしては使えない（FULLTEXT INDEXはN-gramで分けられた単語だけが登録され、実際の値はINDEXには登録されない）</li>
</ul>

  </article>
</section>

  

      </div>

      
  <footer class="footer">
    <section class="container">
      
      
        ©
        
          2017 -
        
        2020
         Fuminori Sakamoto 
      
      
         · 
        Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      
      
    </section>
  </footer>

    </main>

    

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-129776715-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


    

  </body>

</html>
